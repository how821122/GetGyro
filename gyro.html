<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Accelerometer Javascript Test</title>
<meta name="viewport" content="width=device-width,user-scalable=yes" />
<style>

</style>
</head>

<body>

  
<ul>
 
  Name: <input type="text" id="user" value="default"> 
  <button id="Btn">Submit</button>
  <li>User name: <span id="CollectionName">default</span> </p> </li>
 

  <li>acceleration x: <span id="accelerationX"></span>g</li> <li>alpha: <span id="alpha">  </p> </li>
  <li>acceleration y: <span id="accelerationY"></span>g</li> <li>beta:  <span id="beta">   </p> </li>
  <li>acceleration z: <span id="accelerationZ"></span>g</li> <li>gamma: <span id="gamma">  </p> </li>
  
  <li>year: <span id="year"> </p> </li>
  <li>month: <span id="month"> </p> </li>
  <li>date: <span id="date"> </p> </li>
  <li>hours: <span id="hours"> </p> </li>
  <li>minutes: <span id="minutes"> </p> </li>
  <li>seconds: <span id="seconds"> </p> </li>
  <li>msec: <span id="msec"> </p> </li>
 
</ul>



<!--
   使用者名稱(選擇資料庫)
-->
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
 $(document).ready(function(){
    $("#Btn").click(function(){
      document.getElementById("CollectionName").innerHTML = $("#user").val();
    })
 }) 
</script>


<!--
  開始鍵
-->


<!--
  獲得GYRO data
-->

<script type="text/javascript">

function GyroData(){

    if (window.DeviceMotionEvent != undefined) {

      window.ondevicemotion = function(e) {
        document.getElementById("accelerationX").innerHTML = Math.round(e.accelerationIncludingGravity.x);
        document.getElementById("accelerationY").innerHTML = Math.round(e.accelerationIncludingGravity.y);
        document.getElementById("accelerationZ").innerHTML = Math.round(e.accelerationIncludingGravity.z);
      }
    
      window.ondeviceorientation = function(event) {
            document.getElementById("alpha").innerHTML = Math.round(event.alpha);
            document.getElementById("beta").innerHTML = Math.round(event.beta);
            document.getElementById("gamma").innerHTML = Math.round(event.gamma);
      }       
    } 
}

//GyroData();

</script>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>


<!--
  獲得時間 data
-->


<script type="text/javascript">
function showtime(){ 
      time =new Date();
      year=time.getFullYear();
      
 
      var month = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11","12"];
      month_number=time.getMonth();

      date=time.getDate();
      hours = time.getHours();
      minutes = time.getMinutes();
      seconds = time.getSeconds();
      msec = time.getMilliseconds();
      
      var time_array=[year,month[month_number],date,hours,minutes,seconds,msec];
      
      
      document.getElementById("year").innerHTML = time_array[0];
      document.getElementById("month").innerHTML = time_array[1];
      document.getElementById("date").innerHTML = time_array[2];
      document.getElementById("hours").innerHTML = time_array[3];
      document.getElementById("minutes").innerHTML = time_array[4];
      document.getElementById("seconds").innerHTML = time_array[5];
      document.getElementById("msec").innerHTML = time_array[6];
 
      
      setTimeout("showtime()",1);
  }
      
//showtime();
</script>


<!--
   回傳資料給伺服器 
-->

<script> 
 var socket = io();
 
 function R_data(){

      $(document).ready(function(){


        setInterval(function X(){

        var accelerationX = Number($("#accelerationX").text()); 
        var accelerationY = Number($("#accelerationY").text());
        var accelerationZ = Number($("#accelerationZ").text());


        var alpha = Number($("#alpha").text()); 
        var beta  = Number($("#beta").text());
        var gamma = Number($("#gamma").text());


        var year  = Number($("#year").text()) ; 
        var month = Number($("#month").text()) ;
        var date  = Number($("#date").text()) ;

        var hours = Number($("#hours").text()) ;
        var minutes = Number($("#minutes").text()) ;
        var seconds = Number($("#seconds").text()) ;
        var msec =  Number($("#msec").text()) ;

        var CollectionName = $("#CollectionName").text();

    

        var obj = {accelerationX,accelerationY,accelerationZ,alpha,beta,gamma,year,month,date,hours,minutes,seconds,msec,CollectionName} ; 

        
        $("#accelerationX").ready(function(){
          socket.emit('device',obj);
        });
    },20)// per 20ms return a data (50Hz)
  })
}

//R_data();

</script>


<!--
  警報系統 req_meg = 確認狀態的flag
-->

<li> req_meg: <span id="msg"> </p> </li>


<script>


function alert_sys(){
      //prepare alert data 
        
      var CollectionName = $("#CollectionName").text();

        setTimeout(function(){
          $("#msg").ready(function(){
            socket.emit('result',CollectionName);
          });
        },1000);

      //delay 1s and get result of event
        setTimeout(function(){
          setInterval(fall,1000); 
        },1000);
          
      //receive function
        function fall(){      
            socket.on('message',function(msg){ 
                var flag = msg.data;
                document.getElementById("msg").innerHTML = flag; 
            });
        }
        setTimeout(function(){
          setInterval(function(){
            var signal = Number($("#msg").text());
            if(signal ==0){
                alert("error");
            }
            else{
                alert("safe");
            }
          },3000);
        },10000);
}

//alert_sys();

  
</script>
 

<button onclick="Start()">Start</button>

 <script>
    function Start() {
     
      GyroData();
      showtime();
      R_data();
      alert_sys();
    } 
 </script>



 
</body>
</html>
